# Тестовое задание для стажёра Backend

Микросервис для автоматического назначения ревьюверов на Pull Request'ы внутри команд. Реализован в рамках тестового задания (Backend-стажер, осень 2025).

## Стек технологий

* **Язык:** Go 1.25
* **База данных:** PostgreSQL 15
* **Миграции:** golang-migrate
* **Роутер:** chi
* **Драйвер БД:** pgx/v5
* **Инфраструктура:** Docker, Docker Compose

## Быстрый старт

Для запуска требуется установленный Docker и Docker Compose.

### Запуск сервиса

Команда поднимет контейнеры приложения и базы данных, применит миграции и запустит HTTP-сервер на порту `:8080`.

```bash
`docker-compose up`
```

Альтернативно: `make docker-up`

### Остановка сервиса

```bash
make docker-down
```

### Запуск тестов

Запуск интеграционных тестов (требует активного подключения к БД).

```bash
make test
```

### Основные эндпоинты

* `POST /team/add` — Создание команды и пользователей.
* `POST /pullRequest/create` — Создание PR (автоматическое назначение 2-х ревьюверов).
* `POST /pullRequest/merge` — Завершение PR (идемпотентный метод).
* `POST /pullRequest/reassign` — Переназначение ревьювера.
* `GET /stats` — Статистика по сервису (команды, пользователи, PR).

## Архитектурные решения и допущения

В ходе реализации были приняты следующие решения:

**1. Идемпотентность Merge**
Согласно ТЗ, повторный вызов `/merge` не возвращает ошибку, а отдает текущее состояние PR. Это реализовано проверкой статуса перед обновлением в БД.

**2. Алгоритм переназначения**
При переназначении выбирается случайный кандидат из той же команды, исключая:

* Автора PR.
* Уже назначенных ревьюверов.
* Самого заменяемого ревьювера.
* Неактивных пользователей.
  Если кандидатов нет, возвращается ошибка `NO_CANDIDATE`.

**3. Хранение статистики**
Для получения статистики (`GET /stats`) используется единый SQL-запрос с подзапросами, что минимизирует время отклика по сравнению с несколькими последовательными запросами к БД.

**4. Работа с базой данных**
Используется паттерн Repository. Транзакции применяются на уровне методов репозитория (`SavePR`, `SaveTeam`), где требуется атомарное изменение нескольких таблиц (например, обновление PR и списка ревьюверов).

**5. Чистка данных в тестах**
Интеграционные тесты выполняются на реальной БД. Для изоляции тестов используется функция `cleanupDB`, выполняющая `TRUNCATE` таблиц перед каждым сценарием.

## Выполненные дополнительные задания

В рамках работы над проектом были реализованы следующие пункты из списка дополнительных заданий:

1.  **Эндпоинт статистики**
    Реализован метод `GET /stats`, возвращающий агрегированную информацию о количестве команд, пользователей (всего/активных) и Pull Request'ов (открытых/слитых). Для обеспечения производительности сбор данных выполняется одним SQL-запросом.

2.  **Интеграционное тестирование**
    Написаны интеграционные тесты (в директории `tests/`), проверяющие основные сценарии работы сервиса (создание команды, создание PR, назначение ревьюверов) на реальной базе данных PostgreSQL.

3.  **Конфигурация линтера**
    В проект внедрен `golangci-lint` с конфигурацией в `.golangci.yml`. Для статического анализа и обеспечения безопасности кода включен расширенный набор линтеров:
    * **Стандартные:** `errcheck`, `gosimple`, `govet`, `ineffassign`, `staticcheck`, `unused`.
    * **Качество и стиль:** `revive` (замена golint), `gocritic` (поиск багов и проблем производительности), `misspell`.
    * **Безопасность и ресурсы:** `gosec` (поиск уязвимостей), `bodyclose` (контроль закрытия HTTP-тел).